name: Publish to Third-Party Platforms

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to publish (without v prefix)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (without v prefix, leave empty for latest)'
        required: false
        type: string

jobs:
  publish-platforms:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="v${{ inputs.version }}"
            VERSION_NUMBER="${{ inputs.version }}"
          else
            # Get latest release version with proper error handling
            HTTP_CODE=$(curl -s -o /tmp/release.json -w "%{http_code}" https://api.github.com/repos/${{ github.repository }}/releases/latest)
            
            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "Error: Failed to get latest release (HTTP $HTTP_CODE)"
              exit 1
            fi
            
            VERSION=$(jq -r .tag_name /tmp/release.json)
            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              echo "Error: Failed to parse version from release data"
              exit 1
            fi
            
            VERSION_NUMBER="${VERSION#v}"
            rm -f /tmp/release.json
          fi
          
          echo "Version to publish: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_OUTPUT

      - name: Get release package
        run: |
          VERSION_NUMBER="${{ steps.version.outputs.VERSION_NUMBER }}"
          
          # Try to get package from local repository first
          if [ -f "releases/${VERSION_NUMBER}.zip" ]; then
            echo "Found release package in repository: releases/${VERSION_NUMBER}.zip"
            cp "releases/${VERSION_NUMBER}.zip" release.zip
          else
            echo "Package not found locally, downloading from GitHub release..."
            
            # Download from GitHub release
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/${VERSION_NUMBER}.zip"
            
            if wget -q "$DOWNLOAD_URL" -O release.zip; then
              echo "Successfully downloaded from GitHub release"
            else
              echo "Error: Failed to download release package from $DOWNLOAD_URL"
              exit 1
            fi
          fi
          
          # Verify the file exists and has content
          if [ ! -f release.zip ] || [ ! -s release.zip ]; then
            echo "Error: Release package is missing or empty"
            exit 1
          fi
          
          echo "Release package ready: release.zip ($(stat -f%z release.zip 2>/dev/null || stat -c%s release.zip) bytes)"

      - name: Publish to all platforms
        env:
          MODIO_TOKEN: ${{ secrets.MODIO_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ERRORS=""
          SUCCESS_COUNT=0
          TOTAL_COUNT=0
          
          echo "=========================================="
          echo "Starting publication to all platforms"
          echo "Version: $VERSION"
          echo "=========================================="
          
          # Platform 1: mod.io
          echo ""
          echo "Publishing to mod.io..."
          TOTAL_COUNT=$((TOTAL_COUNT + 1))
          
          if [ -z "$MODIO_TOKEN" ]; then
            echo "⚠️  Warning: MODIO_TOKEN not set, skipping mod.io"
            ERRORS="${ERRORS}\n- mod.io: Token not configured"
          else
            # Create a temporary directory for mod.io action
            mkdir -p /tmp/modio-publish
            cp release.zip /tmp/modio-publish/
            
            # Use the mod.io upload action
            # Note: This is a placeholder - the actual implementation would use the action
            # For now, we'll simulate it with a script
            echo "  Game ID: 3659"
            echo "  Mod ID: 5238039"
            echo "  Version: $VERSION"
            echo "  Package: release.zip"
            
            # Simulate mod.io upload (replace with actual action in real workflow)
            if [ -f "release.zip" ]; then
              echo "✓ mod.io: Ready to publish (action will be called)"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              # In real implementation, handle mod.io action errors here
            else
              echo "✗ mod.io: Release package not found"
              ERRORS="${ERRORS}\n- mod.io: Release package not found"
            fi
          fi
          
          # Future platforms can be added here following the same pattern
          # Platform 2: Example Platform
          # echo ""
          # echo "Publishing to Example Platform..."
          # TOTAL_COUNT=$((TOTAL_COUNT + 1))
          # if some_condition; then
          #   SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          # else
          #   ERRORS="${ERRORS}\n- Example Platform: Error message"
          # fi
          
          echo ""
          echo "=========================================="
          echo "Publication Summary"
          echo "=========================================="
          echo "Successful: $SUCCESS_COUNT/$TOTAL_COUNT platforms"
          
          if [ -n "$ERRORS" ]; then
            echo ""
            echo "Errors encountered:"
            echo -e "$ERRORS"
            echo ""
            echo "⚠️  Some platforms failed, but continuing..."
          else
            echo "✓ All platforms published successfully"
          fi
          
          # Store results for next step
          echo "$SUCCESS_COUNT" > /tmp/success_count.txt
          echo "$TOTAL_COUNT" > /tmp/total_count.txt
          if [ -n "$ERRORS" ]; then
            echo -e "$ERRORS" > /tmp/errors.txt
          fi

      - name: Upload to mod.io
        if: env.MODIO_TOKEN != ''
        uses: nickelc/upload-to-modio@v2.1.0
        continue-on-error: true
        id: modio_upload
        with:
          token: ${{ secrets.MODIO_TOKEN }}
          game: 3659
          mod: 5238039
          version: ${{ env.VERSION }}
          path: release.zip

      # TODO: Steam Workshop Publishing
      # Steam Workshop publishing is not yet implemented in this workflow.
      # The original script.sh included Steam Workshop upload functionality (lines 165-192).
      # 
      # To implement Steam Workshop publishing:
      # 1. Set up SteamCMD in a GitHub Actions environment (consider using a self-hosted runner)
      # 2. Add STEAM_USERNAME and STEAM_PASSWORD as repository secrets
      # 3. Create workshop.vdf configuration file with:
      #    - appid: 1062090
      #    - publishedfileid: 3346918947
      #    - contentfolder: path to release package
      #    - changenote: release version
      # 4. Run SteamCMD with workshop_build_item command
      # 5. Add error handling with continue-on-error: true
      # 6. Update the "Check publication results" step to include Steam Workshop status
      #
      # Note: Steam Workshop publishing requires SteamCMD and Steam authentication,
      # which may be better suited for a self-hosted runner or separate workflow.

      - name: Check publication results
        run: |
          HAS_ERRORS=false
          
          # Check mod.io result
          if [ "${{ steps.modio_upload.outcome }}" = "failure" ]; then
            echo "✗ mod.io publication failed"
            HAS_ERRORS=true
          elif [ "${{ steps.modio_upload.outcome }}" = "success" ]; then
            echo "✓ mod.io publication succeeded"
          elif [ -z "${{ secrets.MODIO_TOKEN }}" ]; then
            echo "⚠️  mod.io skipped (token not configured)"
          fi
          
          # Add checks for other platforms here as they are added
          
          echo ""
          if [ "$HAS_ERRORS" = true ]; then
            echo "=========================================="
            echo "⚠️  Publication completed with errors"
            echo "=========================================="
            echo "Some platforms failed to publish. Please check the logs above."
            exit 1
          else
            echo "=========================================="
            echo "✓ Publication completed successfully"
            echo "=========================================="
          fi