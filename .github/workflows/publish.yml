name: Publish to Third-Party Platforms

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to publish (without v prefix)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (without v prefix, leave empty for latest)'
        required: false
        type: string

jobs:
  publish-modio:
    runs-on: ubuntu-latest

    steps:
      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="v${{ inputs.version }}"
          else
            # Get latest release version with error handling
            VERSION=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              echo "Failed to get latest release version"
              exit 1
            fi
          fi
          
          echo "Version to publish: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Download release asset
        run: |
          echo "Downloading version: $VERSION"
          
          # Download the zip file
          wget "https://github.com/${{ github.repository }}/releases/download/${VERSION}/${VERSION#v}.zip" -O release.zip
          
          ls -la release.zip

      - name: Publish to mod.io
        uses: nickelc/upload-to-modio@v2.1.0
        with:
          token: ${{ secrets.MODIO_TOKEN }}
          game: 3659
          mod: 5238039
          version: ${{ env.VERSION }}
          path: release.zip