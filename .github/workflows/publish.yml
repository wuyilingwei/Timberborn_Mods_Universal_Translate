name: Publish to Third-Party Platforms

on:
  workflow_call:
  workflow_dispatch:

jobs:
  publish-platforms:
    if: github.event_name == 'schedule' || contains(fromJSON(vars.WORKFLOWS_ALLOWLIST || '[]'), github.actor)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: |
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}

      - name: Determine version
        id: version
        run: |
          # Read version from repository's .github/data/version.txt
          if [ ! -f ".github/data/version.txt" ]; then
            echo "Error: .github/data/version.txt not found in repository"
            exit 1
          fi
          
          VERSION_NUMBER=$(cat .github/data/version.txt | tr -d '\n\r ')
          
          if [ -z "$VERSION_NUMBER" ]; then
            echo "Error: .github/data/version.txt is empty"
            exit 1
          fi
          
          VERSION="v${VERSION_NUMBER}"
          echo "Read version from repository: $VERSION_NUMBER"
          
          echo "Version to publish: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_OUTPUT

      - name: Get release package for mod.io
        run: |
          VERSION_NUMBER="${{ steps.version.outputs.VERSION_NUMBER }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION_NUMBER}/${VERSION_NUMBER}.zip"
          
          echo "Version to publish: $VERSION_NUMBER"
          echo "Release URL: $RELEASE_URL"
          
          # For mod.io, we need a local file. Download from GitHub Release if not present locally
          if [ -f "${VERSION_NUMBER}.zip" ]; then
            echo "Found local release package: ${VERSION_NUMBER}.zip"
            cp "${VERSION_NUMBER}.zip" release.zip
          else
            echo "Local package not found, downloading from GitHub Release..."
            echo "Download URL: $RELEASE_URL"
            
            # Download the release package
            if curl -L -f -o release.zip "$RELEASE_URL"; then
              echo "✓ Successfully downloaded release package"
            else
              echo "✗ Failed to download release package from GitHub Release"
              echo "  Please ensure the GitHub Release has been created with the package"
              exit 1
            fi
          fi
          
          # Verify the file exists and has content
          if [ ! -f release.zip ] || [ ! -s release.zip ]; then
            echo "Error: Release package is missing or empty"
            exit 1
          fi
          
          FILE_SIZE=$(wc -c < release.zip)
          echo "Release package ready: release.zip ($FILE_SIZE bytes)"

      - name: Publish to all platforms
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          VERSION_NUMBER="${{ steps.version.outputs.VERSION_NUMBER }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION_NUMBER}/${VERSION_NUMBER}.zip"
          
          echo "=========================================="
          echo "Preparing publication to all platforms"
          echo "Version: $VERSION_NUMBER"
          echo "Release URL: $RELEASE_URL"
          echo "=========================================="
          echo ""
          echo "Platform configuration:"
          
          # Check platform availability
          if [ -n "${{ secrets.MODIO_TOKEN }}" ]; then
            echo "✓ mod.io: Token configured"
          else
            echo "⚠️  mod.io: Token not configured (will be skipped)"
          fi
          
          if [ -n "${{ secrets.STEAM_TOKEN }}" ]; then
            echo "✓ Steam Workshop: Token configured"
          else
            echo "⚠️  Steam Workshop: Token not configured (will be skipped)"
          fi
          
          echo ""
          echo "Release files will be fetched directly from GitHub Release"

      - name: Upload to mod.io
        env:
          MODIO_TOKEN: ${{ secrets.MODIO_TOKEN }}
        if: env.MODIO_TOKEN != ''
        uses: nickelc/upload-to-modio@v2.1.0
        continue-on-error: true
        id: modio_upload
        with:
          token: ${{ secrets.MODIO_TOKEN }}
          game: 3659
          mod: 5238039
          version: ${{ steps.version.outputs.VERSION }}
          path: release.zip

      - name: Publish to Steam Workshop
        env:
          STEAM_TOKEN: ${{ secrets.STEAM_TOKEN }}
        if: env.STEAM_TOKEN != ''
        continue-on-error: true
        id: steam_upload
        run: |
          VERSION_NUMBER="${{ steps.version.outputs.VERSION_NUMBER }}"
          CHANGENOTE="Automated Update to ${VERSION_NUMBER}"
          
          # Use GitHub Release direct download URL
          ZIP_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION_NUMBER}/${VERSION_NUMBER}.zip"
          
          echo "Uploading to Steam Workshop via API..."
          echo "App ID: 1062090"
          echo "Published File ID: 3346918947"
          echo "Version: $VERSION_NUMBER"
          echo "Change Note: $CHANGENOTE"
          echo "Package URL: $ZIP_URL"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://steam.wuyilingwei.com/workshop/upload" \
            -H "Authorization: Bearer $STEAM_TOKEN" \
            -F "appid=1062090" \
            -F "publishedfileid=3346918947" \
            -F "zip_url=$ZIP_URL" \
            -F "changenote=$CHANGENOTE")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "API Response Status: $HTTP_CODE"
          echo "API Response Body: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "✓ Steam Workshop upload successful"
            exit 0
          else
            echo "✗ Steam Workshop upload failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Check publication results
        run: |
          HAS_ERRORS=false
          
          # Check mod.io result
          if [ "${{ steps.modio_upload.outcome }}" = "failure" ]; then
            echo "✗ mod.io publication failed"
            HAS_ERRORS=true
          elif [ "${{ steps.modio_upload.outcome }}" = "success" ]; then
            echo "✓ mod.io publication succeeded"
          elif [ -z "${{ secrets.MODIO_TOKEN }}" ]; then
            echo "⚠️  mod.io skipped (token not configured)"
          fi
          
          # Check Steam Workshop result
          if [ "${{ steps.steam_upload.outcome }}" = "failure" ]; then
            echo "✗ Steam Workshop publication failed"
            HAS_ERRORS=true
          elif [ "${{ steps.steam_upload.outcome }}" = "success" ]; then
            echo "✓ Steam Workshop publication succeeded"
          elif [ -z "${{ secrets.STEAM_TOKEN }}" ]; then
            echo "⚠️  Steam Workshop skipped (token not configured)"
          fi
          
          echo ""
          if [ "$HAS_ERRORS" = true ]; then
            echo "=========================================="
            echo "⚠️  Publication completed with errors"
            echo "=========================================="
            echo "Some platforms failed to publish. Please check the logs above."
            exit 1
          else
            echo "=========================================="
            echo "✓ Publication completed successfully"
            echo "=========================================="
          fi