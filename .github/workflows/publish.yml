name: Publish to Third-Party Platforms

on:
  workflow_call:
  workflow_dispatch:

jobs:
  publish-platforms:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: |
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}

      - name: Determine version
        id: version
        run: |
          # Read version from repository's info/version.txt
          if [ ! -f "info/version.txt" ]; then
            echo "Error: info/version.txt not found in repository"
            exit 1
          fi
          
          VERSION_NUMBER=$(cat info/version.txt | tr -d '\n\r ')
          
          if [ -z "$VERSION_NUMBER" ]; then
            echo "Error: info/version.txt is empty"
            exit 1
          fi
          
          VERSION="v${VERSION_NUMBER}"
          echo "Read version from repository: $VERSION_NUMBER"
          
          echo "Version to publish: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=$VERSION_NUMBER" >> $GITHUB_OUTPUT

      - name: Get release package
        run: |
          VERSION_NUMBER="${{ steps.version.outputs.VERSION_NUMBER }}"
          
          # Get package from local repository with fixed name
          if [ -f "releases/newest.zip" ]; then
            echo "Found release package in repository: releases/newest.zip"
            echo "Version to publish: $VERSION_NUMBER"
            cp "releases/newest.zip" release.zip
          else
            echo "Error: Package not found in repository at releases/newest.zip"
            echo ""
            echo "The package should be available in the repository after the build workflow completes."
            echo "If you're running this manually, ensure the build workflow has run successfully"
            echo "and committed the package to the releases/ directory."
            exit 1
          fi
          
          # Verify the file exists and has content
          if [ ! -f release.zip ] || [ ! -s release.zip ]; then
            echo "Error: Release package is missing or empty"
            exit 1
          fi
          
          FILE_SIZE=$(wc -c < release.zip)
          echo "Release package ready: release.zip ($FILE_SIZE bytes)"

      - name: Load changelog
        id: changelog
        run: |
          # Read changelog from info/changelog.md
          if [ -f "info/changelog.md" ]; then
            echo "Found changelog file: info/changelog.md"
            
            # Read first 500 characters for change notes (platform limitations)
            CHANGELOG_CONTENT=$(head -c 500 "info/changelog.md" | sed 's/["\]/\\&/g' | tr '\n' ' ')
            
            # Also create a short summary for platforms with character limits
            VERSION_NUMBER="${{ steps.version.outputs.VERSION_NUMBER }}"
            SHORT_CHANGELOG="Release $VERSION_NUMBER: $(grep -m 1 'üìÑ\|‚úèÔ∏è\|üóëÔ∏è' info/changelog.md | head -1 | sed 's/^[[:space:]]*//' || echo 'Automated update with mod translations and data changes.')"
            
            echo "changelog_content=$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
            echo "short_changelog=$SHORT_CHANGELOG" >> $GITHUB_OUTPUT
            echo "has_changelog=true" >> $GITHUB_OUTPUT
            
            echo "Changelog loaded successfully"
          else
            echo "Warning: changelog.md not found, using default message"
            VERSION_NUMBER="${{ steps.version.outputs.VERSION_NUMBER }}"
            DEFAULT_MSG="Automated Update to $VERSION_NUMBER"
            echo "changelog_content=$DEFAULT_MSG" >> $GITHUB_OUTPUT
            echo "short_changelog=$DEFAULT_MSG" >> $GITHUB_OUTPUT
            echo "has_changelog=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish to all platforms
        env:
          MODIO_TOKEN: ${{ secrets.MODIO_TOKEN }}
          STEAM_TOKEN: ${{ secrets.STEAM_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          echo "=========================================="
          echo "Preparing publication to all platforms"
          echo "Version: $VERSION"
          echo "Package: release.zip"
          echo "=========================================="
          echo ""
          echo "Platform configuration:"
          
          # Check platform availability
          if [ -n "$MODIO_TOKEN" ]; then
            echo "‚úì mod.io: Configured"
          else
            echo "‚ö†Ô∏è  mod.io: Token not configured (will be skipped)"
          fi
          
          if [ -n "$STEAM_TOKEN" ]; then
            echo "‚úì Steam Workshop: Configured"
          else
            echo "‚ö†Ô∏è  Steam Workshop: Token not configured (will be skipped)"
          fi
          
          echo ""
          echo "Note: Actual publishing will be performed in subsequent steps"
          echo "      with individual error handling for each platform."

      - name: Upload to mod.io
        if: ${{ env.MODIO_TOKEN != '' }}
        env:
          MODIO_TOKEN: ${{ secrets.MODIO_TOKEN }}
        uses: nickelc/upload-to-modio@v2.1.0
        continue-on-error: true
        id: modio_upload
        with:
          token: ${{ env.MODIO_TOKEN }}
          game: 3659
          mod: 5238039
          version: ${{ env.VERSION }}
          path: release.zip

      - name: Publish to Steam Workshop
        if: ${{ env.STEAM_TOKEN != '' }}
        env:
          STEAM_TOKEN: ${{ secrets.STEAM_TOKEN }}
        continue-on-error: true
        id: steam_upload
        run: |
          VERSION_NUMBER="${{ steps.version.outputs.VERSION_NUMBER }}"
          
          # Use changelog content or fallback to default
          if [ "${{ steps.changelog.outputs.has_changelog }}" = "true" ]; then
            CHANGENOTE="${{ steps.changelog.outputs.short_changelog }}"
            echo "Using changelog content for change note"
          else
            CHANGENOTE="Automated Update to ${VERSION_NUMBER}"
            echo "Using default change note"
          fi
          
          # Use GitHub raw URL for the package
          ZIP_URL="https://github.com/wuyilingwei/Timberborn_Mods_Universal_Translate/raw/refs/heads/main/releases/newest.zip"
          
          echo "Uploading to Steam Workshop via API..."
          echo "App ID: 1062090"
          echo "Published File ID: 3346918947"
          echo "Version: $VERSION_NUMBER"
          echo "Change Note: $CHANGENOTE"
          echo "Package URL: $ZIP_URL"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://steam.wuyilingwei.com/workshop/upload" \
            -H "Authorization: Bearer $STEAM_TOKEN" \
            -F "appid=1062090" \
            -F "publishedfileid=3346918947" \
            -F "zip_url=$ZIP_URL" \
            -F "changenote=$CHANGENOTE")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "API Response Status: $HTTP_CODE"
          echo "API Response Body: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úì Steam Workshop upload successful"
            exit 0
          else
            echo "‚úó Steam Workshop upload failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Check publication results
        run: |
          HAS_ERRORS=false
          
          # Check mod.io result
          if [ "${{ steps.modio_upload.outcome }}" = "failure" ]; then
            echo "‚úó mod.io publication failed"
            HAS_ERRORS=true
          elif [ "${{ steps.modio_upload.outcome }}" = "success" ]; then
            echo "‚úì mod.io publication succeeded"
          elif [ -z "${{ secrets.MODIO_TOKEN }}" ]; then
            echo "‚ö†Ô∏è  mod.io skipped (token not configured)"
          fi
          
          # Check Steam Workshop result
          if [ "${{ steps.steam_upload.outcome }}" = "failure" ]; then
            echo "‚úó Steam Workshop publication failed"
            HAS_ERRORS=true
          elif [ "${{ steps.steam_upload.outcome }}" = "success" ]; then
            echo "‚úì Steam Workshop publication succeeded"
          elif [ -z "${{ secrets.STEAM_TOKEN }}" ]; then
            echo "‚ö†Ô∏è  Steam Workshop skipped (token not configured)"
          fi
          
          echo ""
          if [ "$HAS_ERRORS" = true ]; then
            echo "=========================================="
            echo "‚ö†Ô∏è  Publication completed with errors"
            echo "=========================================="
            echo "Some platforms failed to publish. Please check the logs above."
            exit 1
          else
            echo "=========================================="
            echo "‚úì Publication completed successfully"
            echo "=========================================="
          fi